<!-- SCALAR field: label row + input with 3-mode selector -->
<div *ngIf="field.fieldType === 'SCALAR'" class="field-row" [class.field-required-unmapped]="field.required && !getStringValue()">
  <div class="field-label">
    <span class="field-name">{{ field.name }}</span>
    <span class="field-meta">({{ field.type }}{{ field.required ? ', required' : '' }})</span>
  </div>
  <div class="field-input">
    <div class="input-mode-group">
      <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'browse'" [disabled]="disabled" (click)="setInputMode('browse')" [title]="'browseMode' | pluginTranslate: pluginId | async">⊞</button>
      <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'pv'" [disabled]="disabled" (click)="setInputMode('pv')" [title]="'pvMode' | pluginTranslate: pluginId | async">pv</button>
      <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'expression'" [disabled]="disabled" (click)="setInputMode('expression')" [title]="'expressionMode' | pluginTranslate: pluginId | async">fx</button>
    </div>

    <!-- Browse mode: ValuePathSelector -->
    <div class="field-input-control" *ngIf="inputMode === 'browse'">
      <valtimo-value-path-selector
        [name]="'field_' + field.path"
        [caseDefinitionKey]="caseDefinitionKey"
        [prefixes]="[ValuePathSelectorPrefix.DOC, ValuePathSelectorPrefix.CASE]"
        [notation]="'dots'"
        [disabled]="disabled"
        [defaultValue]="getStringValue()"
        [showCaseDefinitionSelector]="!caseDefinitionKey"
        (valueChangeEvent)="onBrowseValueChange($event)"
      ></valtimo-value-path-selector>
    </div>

    <!-- PV mode: dropdown (when available) or text fallback -->
    <div class="field-input-control" *ngIf="inputMode === 'pv'">
      <select
        *ngIf="processVariables.length > 0; else pvFallback"
        class="pv-select"
        [disabled]="disabled"
        (change)="onPvChange($any($event.target).value)"
      >
        <option value="">{{ 'pvPlaceholder' | pluginTranslate: pluginId | async }}</option>
        <option *ngFor="let pv of processVariables" [value]="pv" [selected]="pv === getPvName()">{{ pv }}</option>
      </select>
      <ng-template #pvFallback>
        <v-input
          [name]="'pvfb_' + field.path"
          [defaultValue]="getPvName()"
          [disabled]="disabled"
          [placeholder]="'pvPlaceholder' | pluginTranslate: pluginId | async"
          (valueChange)="onPvChange($event)"
        ></v-input>
      </ng-template>
    </div>

    <!-- Expression mode: text input -->
    <div class="field-input-control" *ngIf="inputMode === 'expression'">
      <v-input
        [name]="'fx_' + field.path"
        [defaultValue]="getStringValue()"
        [disabled]="disabled"
        [placeholder]="'e.g. pv:variableName or doc:path.to.field'"
        (valueChange)="onExpressionValueChange($event)"
      ></v-input>
    </div>
  </div>
</div>

<!-- OBJECT field: collapsible section with children -->
<div *ngIf="field.fieldType === 'OBJECT'" class="field-object">
  <div class="field-object-header" (click)="toggleExpanded()" [class.field-required-unmapped]="totalRequired > 0 && mappedCount < totalRequired">
    <span class="expand-icon">{{ expanded ? '▼' : '▶' }}</span>
    <span class="field-name">{{ field.name }}</span>
    <span class="field-meta">(object{{ field.required ? ', required' : '' }})</span>
    <span class="completeness-badge" *ngIf="totalRequired > 0 && !expanded">
      {{ mappedCount }}/{{ totalRequired }}
    </span>
  </div>
  <div class="field-object-children" *ngIf="expanded">
    <epistola-field-tree
      *ngFor="let child of field.children"
      [field]="child"
      [value]="getChildValue(child.name)"
      [pluginId]="pluginId"
      [caseDefinitionKey]="caseDefinitionKey"
      [processVariables]="processVariables"
      [disabled]="disabled"
      (valueChange)="onChildChange(child.name, $event)"
    ></epistola-field-tree>
  </div>
</div>

<!-- ARRAY field: collapsible section with source collection + optional per-item mapping -->
<div *ngIf="field.fieldType === 'ARRAY'" class="field-array">
  <div class="field-array-header" (click)="toggleExpanded()" [class.field-required-unmapped]="field.required && !getSourceValue()">
    <span class="expand-icon">{{ expanded ? '▼' : '▶' }}</span>
    <span class="field-name">{{ field.name }}</span>
    <span class="field-meta">(array{{ field.required ? ', required' : '' }})</span>
    <span class="completeness-badge" *ngIf="totalRequired > 0 && !expanded">
      {{ mappedCount }}/{{ totalRequired }}
    </span>
    <span class="mapped-indicator" *ngIf="totalRequired === 0 && getSourceValue() && !expanded">✓</span>
  </div>
  <div class="field-array-content" *ngIf="expanded">
    <!-- Source collection input -->
    <div class="field-row">
      <div class="field-label">
        <span class="field-name">{{ 'mapCollectionTo' | pluginTranslate: pluginId | async }}</span>
      </div>
      <div class="field-input">
        <div class="input-mode-group">
          <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'browse'" [disabled]="disabled" (click)="setInputMode('browse')" [title]="'browseMode' | pluginTranslate: pluginId | async">⊞</button>
          <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'pv'" [disabled]="disabled" (click)="setInputMode('pv')" [title]="'pvMode' | pluginTranslate: pluginId | async">pv</button>
          <button type="button" class="mode-btn" [class.mode-active]="inputMode === 'expression'" [disabled]="disabled" (click)="setInputMode('expression')" [title]="'expressionMode' | pluginTranslate: pluginId | async">fx</button>
        </div>

        <div class="field-input-control" *ngIf="inputMode === 'browse'">
          <valtimo-value-path-selector
            [name]="'field_' + field.path"
            [caseDefinitionKey]="caseDefinitionKey"
            [prefixes]="[ValuePathSelectorPrefix.DOC, ValuePathSelectorPrefix.CASE]"
            [notation]="'dots'"
            [disabled]="disabled"
            [defaultValue]="getSourceValue()"
            [showCaseDefinitionSelector]="!caseDefinitionKey"
            (valueChangeEvent)="onSourceBrowseChange($event)"
          ></valtimo-value-path-selector>
        </div>

        <div class="field-input-control" *ngIf="inputMode === 'pv'">
          <select
            *ngIf="processVariables.length > 0; else pvSourceFallback"
            class="pv-select"
            [disabled]="disabled"
            (change)="onSourcePvChange($any($event.target).value)"
          >
            <option value="">{{ 'pvPlaceholder' | pluginTranslate: pluginId | async }}</option>
            <option *ngFor="let pv of processVariables" [value]="pv" [selected]="pv === getSourcePvName()">{{ pv }}</option>
          </select>
          <ng-template #pvSourceFallback>
            <v-input
              [name]="'pvfb_' + field.path"
              [defaultValue]="getSourcePvName()"
              [disabled]="disabled"
              [placeholder]="'pvPlaceholder' | pluginTranslate: pluginId | async"
              (valueChange)="onSourcePvChange($event)"
            ></v-input>
          </ng-template>
        </div>

        <div class="field-input-control" *ngIf="inputMode === 'expression'">
          <v-input
            [name]="'fx_' + field.path"
            [defaultValue]="getSourceValue()"
            [disabled]="disabled"
            [placeholder]="'e.g. pv:variableName or doc:path.to.field'"
            (valueChange)="onSourceExpressionChange($event)"
          ></v-input>
        </div>
      </div>
    </div>

    <!-- Per-item field mapping toggle (only shown when array has children) -->
    <div class="array-per-field-toggle" *ngIf="hasArrayChildren()">
      <label class="toggle-label">
        <input
          type="checkbox"
          [checked]="arrayPerFieldMode"
          [disabled]="disabled"
          (change)="toggleArrayPerFieldMode()"
        />
        <span>{{ 'itemFieldMapping' | pluginTranslate: pluginId | async }}</span>
      </label>
    </div>

    <!-- Per-item field mappings -->
    <div class="array-item-fields" *ngIf="arrayPerFieldMode && hasArrayChildren()">
      <div class="item-fields-header">
        <span class="item-fields-title">{{ 'itemFieldMappingTitle' | pluginTranslate: pluginId | async }}</span>
      </div>
      <div class="item-field-row" *ngFor="let child of field.children">
        <div class="item-field-label">
          <span class="field-name">{{ child.name }}</span>
          <span class="field-meta">({{ child.type }}{{ child.required ? ', required' : '' }})</span>
        </div>
        <div class="item-field-input">
          <v-input
            [name]="'itemField_' + child.path"
            [defaultValue]="getItemFieldValue(child.name)"
            [disabled]="disabled"
            [placeholder]="'sourceFieldPlaceholder' | pluginTranslate: pluginId | async"
            (valueChange)="onItemFieldChange(child.name, $event)"
          ></v-input>
        </div>
      </div>
    </div>
  </div>
</div>

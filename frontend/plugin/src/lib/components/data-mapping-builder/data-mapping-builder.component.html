<div class="data-mapping-builder" *ngIf="{
  disabled: disabled$ | async,
  templateFields: templateFields$ | async,
  templateFieldOptions: templateFieldOptions$ | async,
  processVariableOptions: processVariableOptions$ | async
} as obs">
  <div class="mapping-header">
    <h5>{{ 'dataMappingTitle' | pluginTranslate: pluginId | async }}</h5>
    <p class="helper-text">{{ 'dataMappingDescription' | pluginTranslate: pluginId | async }}</p>
  </div>

  <div class="mapping-table" *ngIf="mappings.length > 0">
    <div class="mapping-row mapping-header-row">
      <div class="mapping-cell template-field-cell">
        {{ 'templateField' | pluginTranslate: pluginId | async }}
      </div>
      <div class="mapping-cell source-type-cell">
        {{ 'sourceType' | pluginTranslate: pluginId | async }}
      </div>
      <div class="mapping-cell data-source-cell">
        {{ 'dataSource' | pluginTranslate: pluginId | async }}
      </div>
      <div class="mapping-cell actions-cell"></div>
    </div>

    <div class="mapping-row" *ngFor="let mapping of mappings; let i = index; trackBy: trackByMapping"
         [class.mapping-row-required-unmapped]="mapping.templateField && !mapping.value && isRequiredField(mapping.templateField)">
      <!-- Template field selector -->
      <div class="mapping-cell template-field-cell">
        <v-select
          [name]="'templateField_' + i"
          [items]="obs.templateFieldOptions"
          [defaultSelectionId]="mapping.templateField"
          [disabled]="obs.disabled"
          [required]="true"
          (selectedChange)="onTemplateFieldChange(i, $event)"
        ></v-select>
      </div>

      <!-- Source type selector -->
      <div class="mapping-cell source-type-cell">
        <v-select
          [name]="'sourceType_' + i"
          [items]="sourceTypeOptions"
          [defaultSelectionId]="mapping.sourceType"
          [disabled]="obs.disabled"
          (selectedChange)="onSourceTypeChange(i, $event)"
        ></v-select>
      </div>

      <!-- Value input: depends on source type -->
      <div class="mapping-cell data-source-cell">
        <!-- Document field: ValuePathSelector -->
        <ng-container *ngIf="mapping.sourceType === 'document'">
          <valtimo-value-path-selector
            [name]="'docPath_' + i"
            [caseDefinitionKey]="caseDefinitionKey"
            [prefixes]="[ValuePathSelectorPrefix.DOC, ValuePathSelectorPrefix.CASE]"
            [notation]="'dots'"
            [disabled]="obs.disabled"
            [defaultValue]="getDocDefaultValue(mapping)"
            (valueChangeEvent)="onDocValueChange(i, $event)"
          ></valtimo-value-path-selector>
        </ng-container>

        <!-- Process variable: autocomplete select with free-text fallback -->
        <ng-container *ngIf="mapping.sourceType === 'processVariable'">
          <div class="pv-input-group">
            <v-select
              *ngIf="processVariables.length > 0"
              [name]="'pvSelect_' + i"
              [items]="obs.processVariableOptions"
              [defaultSelectionId]="getPvDefaultValue(mapping)"
              [disabled]="obs.disabled"
              (selectedChange)="onPvChange(i, $event)"
            ></v-select>
            <v-input
              *ngIf="processVariables.length === 0"
              [name]="'pvInput_' + i"
              [defaultValue]="getPvDefaultValue(mapping)"
              [disabled]="obs.disabled"
              [placeholder]="'e.g. invoiceTotal'"
              (valueChange)="onPvManualChange(i, $event)"
            ></v-input>
          </div>
        </ng-container>

        <!-- Manual value: free text input -->
        <ng-container *ngIf="mapping.sourceType === 'manual'">
          <v-input
            [name]="'manualValue_' + i"
            [defaultValue]="mapping.value"
            [disabled]="obs.disabled"
            [placeholder]="'e.g. doc:path.to.field or pv:variableName'"
            (valueChange)="onManualValueChange(i, $event)"
          ></v-input>
        </ng-container>
      </div>

      <!-- Remove button -->
      <div class="mapping-cell actions-cell">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger"
          [disabled]="obs.disabled"
          (click)="removeMapping(i)"
          title="Remove mapping"
        >
          <span class="mdi mdi-delete"></span>
        </button>
      </div>
    </div>
  </div>

  <div class="no-mappings" *ngIf="mappings.length === 0">
    <p>{{ 'noMappings' | pluginTranslate: pluginId | async }}</p>
  </div>

  <div class="mapping-actions">
    <button
      type="button"
      class="btn btn-sm btn-outline-primary"
      [disabled]="obs.disabled"
      (click)="addMapping()"
    >
      <span class="mdi mdi-plus"></span>
      {{ 'addMapping' | pluginTranslate: pluginId | async }}
    </button>
  </div>
</div>

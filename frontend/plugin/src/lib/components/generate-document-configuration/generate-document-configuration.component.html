<v-form
    (valueChange)="formValueChange($event)"
    *ngIf="{
      disabled: disabled$ | async,
      prefill: prefillConfiguration$ ? (prefillConfiguration$ | async) : null,
      templateOptions: templateOptions$ | async,
      templatesLoading: templatesLoading$ | async,
      variantOptions: variantOptions$ | async,
      variantsLoading: variantsLoading$ | async,
      environmentOptions: environmentOptions$ | async,
      environmentsLoading: environmentsLoading$ | async,
      templateFieldsLoading: templateFieldsLoading$ | async,
      selectedTemplateId: selectedTemplateId$ | async
    } as obs"
>
  <v-select
    name="templateId"
    [title]="'templateId' | pluginTranslate: pluginId | async"
    [tooltip]="'templateIdTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [items]="obs.templateOptions"
    [defaultSelectionId]="obs.prefill?.templateId"
    [disabled]="obs.disabled || obs.templatesLoading"
    [required]="true"
    [loading]="obs.templatesLoading"
  >
  </v-select>

  <v-select
    name="variantId"
    [title]="'variantId' | pluginTranslate: pluginId | async"
    [tooltip]="'variantIdTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [items]="obs.variantOptions"
    [defaultSelectionId]="obs.prefill?.variantId"
    [disabled]="obs.disabled || obs.variantsLoading || !obs.selectedTemplateId"
    [required]="true"
    [loading]="obs.variantsLoading"
  >
  </v-select>

  <v-select
    name="environmentId"
    [title]="'environmentId' | pluginTranslate: pluginId | async"
    [tooltip]="'environmentIdTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [items]="obs.environmentOptions"
    [defaultSelectionId]="obs.prefill?.environmentId"
    [disabled]="obs.disabled || obs.environmentsLoading"
    [required]="false"
    [loading]="obs.environmentsLoading"
  >
  </v-select>

  <v-select
    name="outputFormat"
    [title]="'outputFormat' | pluginTranslate: pluginId | async"
    [tooltip]="'outputFormatTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [items]="outputFormatOptions"
    [defaultSelectionId]="obs.prefill?.outputFormat || 'PDF'"
    [disabled]="obs.disabled"
    [required]="true"
  >
  </v-select>

  <v-input
    name="filename"
    [title]="'filename' | pluginTranslate: pluginId | async"
    [tooltip]="'filenameTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [defaultValue]="obs.prefill?.filename"
    [disabled]="obs.disabled"
    [required]="true"
  >
  </v-input>

  <v-input
    name="correlationId"
    [title]="'correlationId' | pluginTranslate: pluginId | async"
    [tooltip]="'correlationIdTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [defaultValue]="obs.prefill?.correlationId"
    [disabled]="obs.disabled"
    [required]="false"
  >
  </v-input>

  <v-input
    name="resultProcessVariable"
    [title]="'resultProcessVariable' | pluginTranslate: pluginId | async"
    [tooltip]="'resultProcessVariableTooltip' | pluginTranslate: pluginId | async"
    [margin]="true"
    [defaultValue]="obs.prefill?.resultProcessVariable"
    [disabled]="obs.disabled"
    [required]="true"
  >
  </v-input>
</v-form>

<epistola-data-mapping-builder
  *ngIf="(selectedTemplateId$ | async)"
  [pluginId]="pluginId"
  [templateFields$]="templateFields$"
  [disabled$]="disabled$"
  [prefillMapping$]="prefillDataMapping$"
  [caseDefinitionKey]="caseDefinitionKey"
  [processVariables]="processVariables"
  (mappingChange)="onDataMappingChange($event)"
  (requiredFieldsStatus)="onRequiredFieldsStatusChange($event)"
></epistola-data-mapping-builder>

<div class="validation-summary" *ngIf="(selectedTemplateId$ | async) && requiredFieldsStatus.total > 0">
  <span *ngIf="requiredFieldsStatus.mapped === requiredFieldsStatus.total" class="validation-complete">
    {{ 'requiredFieldsComplete' | pluginTranslate: pluginId | async }}
  </span>
  <span *ngIf="requiredFieldsStatus.mapped < requiredFieldsStatus.total" class="validation-incomplete">
    {{ requiredFieldsStatus.mapped }} / {{ requiredFieldsStatus.total }}
    {{ 'validationSummary' | pluginTranslate: pluginId | async }}
  </span>
</div>

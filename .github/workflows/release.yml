name: Release

on:
  push:
    branches:
      - main
      - 'release/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g. 1.0.3). Leave empty for auto-increment.'
        required: false
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  version:
    name: Determine version
    runs-on: ubuntu-latest
    if: >-
      contains(github.event.head_commit.message, '[release]') ||
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/heads/release/')
    outputs:
      version: ${{ steps.version.outputs.version }}
      major_minor: ${{ steps.version.outputs.major_minor }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          # Manual override takes precedence
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "major_minor=${VERSION%.*}" >> "$GITHUB_OUTPUT"
            echo "Using manual version override: ${VERSION}"
            exit 0
          fi

          # Read major.minor from build.gradle.kts
          PROJECT_VERSION=$(grep -E '^version\s*=' build.gradle.kts | head -1 | sed -E 's/.*"([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [ -z "$PROJECT_VERSION" ]; then
            echo "::error::Could not read version from build.gradle.kts"
            exit 1
          fi
          MAJOR_MINOR=$(echo "$PROJECT_VERSION" | sed -E 's/([0-9]+\.[0-9]+)\.[0-9]+/\1/')
          echo "build.gradle.kts version: ${PROJECT_VERSION}, Major.Minor: ${MAJOR_MINOR}"

          # For release/* branches, validate that branch version matches build.gradle.kts
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [[ "$BRANCH" == release/* ]]; then
            BRANCH_VERSION="${BRANCH#release/}"
            if [ "$BRANCH_VERSION" != "$MAJOR_MINOR" ]; then
              echo "::error::Branch version ${BRANCH_VERSION} does not match build.gradle.kts version ${MAJOR_MINOR}"
              exit 1
            fi
            echo "Branch version ${BRANCH_VERSION} matches build.gradle.kts"
          fi

          echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"

          # Find highest patch version among existing tags for this major.minor
          LATEST_PATCH=-1
          for tag in $(git tag -l "v${MAJOR_MINOR}.*"); do
            PATCH=$(echo "$tag" | sed -E "s/v${MAJOR_MINOR}\.([0-9]+)/\1/")
            if [ "$PATCH" -gt "$LATEST_PATCH" ] 2>/dev/null; then
              LATEST_PATCH=$PATCH
            fi
          done

          NEXT_PATCH=$((LATEST_PATCH + 1))
          VERSION="${MAJOR_MINOR}.${NEXT_PATCH}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${VERSION} (previous highest patch: ${LATEST_PATCH})"

  build:
    name: Build & Test
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build & test backend plugin
        run: ./gradlew :backend:plugin:build -Pversion=${{ needs.version.outputs.version }}

      - name: Build frontend plugin
        run: pnpm --filter @epistola.app/valtimo-plugin build

  publish-backend:
    name: Publish Backend to Maven Central
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Publish to Maven Central
        run: ./gradlew :backend:plugin:publishAndReleaseToMavenCentral -Pversion=${{ needs.version.outputs.version }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}

  publish-frontend:
    name: Publish Frontend to npm
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build plugin
        run: pnpm --filter @epistola.app/valtimo-plugin build

      - name: Set version and publish
        working-directory: frontend/plugin/dist
        run: |
          npm version "${{ needs.version.outputs.version }}" --no-git-tag-version
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  docker-backend:
    name: Docker Backend
    needs: [version, publish-backend]
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/epistola-app/valtimo/demo-backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Build WAR
        run: ./gradlew :test-app:backend:bootWar -Pversion=${{ needs.version.outputs.version }}

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: test-app/backend
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ needs.version.outputs.version }}
            ${{ env.IMAGE }}:${{ needs.version.outputs.major_minor }}
            ${{ env.IMAGE }}:sha-${{ github.sha }}

      - uses: sigstore/cosign-installer@v3

      - name: Sign image
        run: cosign sign --yes "${{ env.IMAGE }}@${{ steps.build.outputs.digest }}"

  docker-frontend:
    name: Docker Frontend
    needs: [version, publish-frontend]
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/epistola-app/valtimo/demo-frontend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build plugin
        run: pnpm --filter @epistola.app/valtimo-plugin build

      - name: Build test-app
        run: pnpm --filter gzac-frontend-template build

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: test-app/frontend
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ needs.version.outputs.version }}
            ${{ env.IMAGE }}:${{ needs.version.outputs.major_minor }}
            ${{ env.IMAGE }}:sha-${{ github.sha }}

      - uses: sigstore/cosign-installer@v3

      - name: Sign image
        run: cosign sign --yes "${{ env.IMAGE }}@${{ steps.build.outputs.digest }}"

  github-release:
    name: Create GitHub Release
    needs: [version, docker-backend, docker-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: v${{ needs.version.outputs.version }}
          body: |
            ## v${{ needs.version.outputs.version }}

            ### Maven (backend plugin)
            ```xml
            <dependency>
                <groupId>app.epistola.valtimo</groupId>
                <artifactId>epistola-plugin</artifactId>
                <version>${{ needs.version.outputs.version }}</version>
            </dependency>
            ```

            ### Gradle (Kotlin DSL)
            ```kotlin
            implementation("app.epistola.valtimo:epistola-plugin:${{ needs.version.outputs.version }}")
            ```

            ### npm (frontend plugin)
            ```bash
            npm install @epistola.app/valtimo-plugin@${{ needs.version.outputs.version }}
            ```

            ### Docker images
            ```
            ghcr.io/epistola-app/valtimo/demo-backend:${{ needs.version.outputs.version }}
            ghcr.io/epistola-app/valtimo/demo-frontend:${{ needs.version.outputs.version }}
            ```
          draft: false
          prerelease: false
          generate_release_notes: true

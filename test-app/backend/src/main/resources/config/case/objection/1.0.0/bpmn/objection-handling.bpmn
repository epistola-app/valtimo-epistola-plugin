<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  id="Definitions_objection"
                  targetNamespace="http://bpmn.io/schema/bpmn"
                  exporter="Camunda Modeler" exporterVersion="5.23.0">

  <bpmn:message id="Message_EpistolaDocumentGenerated" name="EpistolaDocumentGenerated" />
  <bpmn:error id="Error_EpistolaDocumentError" name="EpistolaDocumentError" />

  <bpmn:process id="objection-handling" name="Bezwaarprocedure" isExecutable="true">
    <bpmn:documentation>Handles an objection: generates acknowledgment, assesses objection, generates decision letter based on outcome.</bpmn:documentation>

    <!-- ===== Phase 1: Acknowledgment ===== -->

    <bpmn:startEvent id="startEvent" name="Bezwaar ontvangen">
      <bpmn:outgoing>Flow_to_gen_ack</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:serviceTask id="generate-ack" name="Genereer Ontvangstbevestiging">
      <bpmn:incoming>Flow_to_gen_ack</bpmn:incoming>
      <bpmn:outgoing>Flow_to_wait_ack</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:boundaryEvent id="boundary-ack-error" attachedToRef="generate-ack">
      <bpmn:outgoing>Flow_ack_error</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorDef_ack" errorRef="Error_EpistolaDocumentError"
                                  camunda:errorCodeVariable="errorCode" camunda:errorMessageVariable="errorMessage" />
    </bpmn:boundaryEvent>

    <bpmn:intermediateCatchEvent id="wait-for-ack" name="Wacht op ontvangstbevestiging">
      <bpmn:incoming>Flow_to_wait_ack</bpmn:incoming>
      <bpmn:outgoing>Flow_to_check_ack</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageDef_ack" messageRef="Message_EpistolaDocumentGenerated" />
    </bpmn:intermediateCatchEvent>

    <bpmn:exclusiveGateway id="check-ack-status" name="Ontvangstbevestiging gereed?">
      <bpmn:incoming>Flow_to_check_ack</bpmn:incoming>
      <bpmn:outgoing>Flow_ack_ok</bpmn:outgoing>
      <bpmn:outgoing>Flow_ack_fail</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="download-ack" name="Download Ontvangstbevestiging">
      <bpmn:incoming>Flow_ack_ok</bpmn:incoming>
      <bpmn:outgoing>Flow_to_assess</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ===== Phase 2: Assessment ===== -->

    <bpmn:userTask id="assess-objection" name="Beoordeel Bezwaar">
      <bpmn:incoming>Flow_to_assess</bpmn:incoming>
      <bpmn:outgoing>Flow_to_decision_gw</bpmn:outgoing>
    </bpmn:userTask>

    <!-- ===== Phase 3: Decision letter (conditional) ===== -->

    <bpmn:exclusiveGateway id="decision-gateway" name="Beslissing?">
      <bpmn:incoming>Flow_to_decision_gw</bpmn:incoming>
      <bpmn:outgoing>Flow_gegrond</bpmn:outgoing>
      <bpmn:outgoing>Flow_ongegrond</bpmn:outgoing>
      <bpmn:outgoing>Flow_deels_gegrond</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="generate-decision-gegrond" name="Genereer Besluit (Gegrond)">
      <bpmn:incoming>Flow_gegrond</bpmn:incoming>
      <bpmn:outgoing>Flow_gegrond_to_merge</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="generate-decision-ongegrond" name="Genereer Besluit (Ongegrond)">
      <bpmn:incoming>Flow_ongegrond</bpmn:incoming>
      <bpmn:outgoing>Flow_ongegrond_to_merge</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="generate-decision-partial" name="Genereer Besluit (Deels gegrond)">
      <bpmn:incoming>Flow_deels_gegrond</bpmn:incoming>
      <bpmn:outgoing>Flow_partial_to_merge</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="merge-gateway">
      <bpmn:incoming>Flow_gegrond_to_merge</bpmn:incoming>
      <bpmn:incoming>Flow_ongegrond_to_merge</bpmn:incoming>
      <bpmn:incoming>Flow_partial_to_merge</bpmn:incoming>
      <bpmn:outgoing>Flow_to_wait_decision</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:intermediateCatchEvent id="wait-for-decision" name="Wacht op besluit">
      <bpmn:incoming>Flow_to_wait_decision</bpmn:incoming>
      <bpmn:outgoing>Flow_to_check_decision</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageDef_decision" messageRef="Message_EpistolaDocumentGenerated" />
    </bpmn:intermediateCatchEvent>

    <bpmn:exclusiveGateway id="check-decision-status" name="Besluit gereed?">
      <bpmn:incoming>Flow_to_check_decision</bpmn:incoming>
      <bpmn:outgoing>Flow_decision_ok</bpmn:outgoing>
      <bpmn:outgoing>Flow_decision_fail</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="download-decision" name="Download Besluit">
      <bpmn:incoming>Flow_decision_ok</bpmn:incoming>
      <bpmn:outgoing>Flow_to_end</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ===== End events ===== -->

    <bpmn:endEvent id="end-success" name="Bezwaar afgehandeld">
      <bpmn:incoming>Flow_to_end</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end-error" name="Fout">
      <bpmn:incoming>Flow_ack_error</bpmn:incoming>
      <bpmn:incoming>Flow_ack_fail</bpmn:incoming>
      <bpmn:incoming>Flow_decision_fail</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ===== Sequence flows ===== -->

    <!-- Phase 1 flows -->
    <bpmn:sequenceFlow id="Flow_to_gen_ack" sourceRef="startEvent" targetRef="generate-ack" />
    <bpmn:sequenceFlow id="Flow_to_wait_ack" sourceRef="generate-ack" targetRef="wait-for-ack" />
    <bpmn:sequenceFlow id="Flow_ack_error" sourceRef="boundary-ack-error" targetRef="end-error" />
    <bpmn:sequenceFlow id="Flow_to_check_ack" sourceRef="wait-for-ack" targetRef="check-ack-status" />
    <bpmn:sequenceFlow id="Flow_ack_ok" name="Ja" sourceRef="check-ack-status" targetRef="download-ack">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus == 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ack_fail" name="Nee" sourceRef="check-ack-status" targetRef="end-error">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus != 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_to_assess" sourceRef="download-ack" targetRef="assess-objection" />

    <!-- Phase 2/3 flows -->
    <bpmn:sequenceFlow id="Flow_to_decision_gw" sourceRef="assess-objection" targetRef="decision-gateway" />
    <bpmn:sequenceFlow id="Flow_gegrond" name="Gegrond" sourceRef="decision-gateway" targetRef="generate-decision-gegrond">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${decision == 'gegrond'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ongegrond" name="Ongegrond" sourceRef="decision-gateway" targetRef="generate-decision-ongegrond">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${decision == 'ongegrond'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_deels_gegrond" name="Deels gegrond" sourceRef="decision-gateway" targetRef="generate-decision-partial">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${decision == 'deels_gegrond'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_gegrond_to_merge" sourceRef="generate-decision-gegrond" targetRef="merge-gateway" />
    <bpmn:sequenceFlow id="Flow_ongegrond_to_merge" sourceRef="generate-decision-ongegrond" targetRef="merge-gateway" />
    <bpmn:sequenceFlow id="Flow_partial_to_merge" sourceRef="generate-decision-partial" targetRef="merge-gateway" />
    <bpmn:sequenceFlow id="Flow_to_wait_decision" sourceRef="merge-gateway" targetRef="wait-for-decision" />
    <bpmn:sequenceFlow id="Flow_to_check_decision" sourceRef="wait-for-decision" targetRef="check-decision-status" />
    <bpmn:sequenceFlow id="Flow_decision_ok" name="Ja" sourceRef="check-decision-status" targetRef="download-decision">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus == 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_decision_fail" name="Nee" sourceRef="check-decision-status" targetRef="end-error">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus != 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_to_end" sourceRef="download-decision" targetRef="end-success" />

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="objection-handling">
      <!-- Row 1: Acknowledgment phase (y=177) -->
      <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
        <dc:Bounds x="179" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="generate-ack_di" bpmnElement="generate-ack">
        <dc:Bounds x="280" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="boundary-ack-error_di" bpmnElement="boundary-ack-error">
        <dc:Bounds x="312" y="199" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="wait-for-ack_di" bpmnElement="wait-for-ack">
        <dc:Bounds x="452" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="check-ack-status_di" bpmnElement="check-ack-status" isMarkerVisible="true">
        <dc:Bounds x="555" y="152" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="download-ack_di" bpmnElement="download-ack">
        <dc:Bounds x="680" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="assess-objection_di" bpmnElement="assess-objection">
        <dc:Bounds x="850" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>

      <!-- Row 2: Decision phase (y=350) -->
      <bpmndi:BPMNShape id="decision-gateway_di" bpmnElement="decision-gateway" isMarkerVisible="true">
        <dc:Bounds x="875" y="325" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="generate-decision-gegrond_di" bpmnElement="generate-decision-gegrond">
        <dc:Bounds x="1000" y="240" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="generate-decision-ongegrond_di" bpmnElement="generate-decision-ongegrond">
        <dc:Bounds x="1000" y="340" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="generate-decision-partial_di" bpmnElement="generate-decision-partial">
        <dc:Bounds x="1000" y="440" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="merge-gateway_di" bpmnElement="merge-gateway" isMarkerVisible="true">
        <dc:Bounds x="1175" y="325" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="wait-for-decision_di" bpmnElement="wait-for-decision">
        <dc:Bounds x="1282" y="332" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="check-decision-status_di" bpmnElement="check-decision-status" isMarkerVisible="true">
        <dc:Bounds x="1375" y="325" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="download-decision_di" bpmnElement="download-decision">
        <dc:Bounds x="1490" y="310" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="end-success_di" bpmnElement="end-success">
        <dc:Bounds x="1662" y="332" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Error end (y=500) -->
      <bpmndi:BPMNShape id="end-error_di" bpmnElement="end-error">
        <dc:Bounds x="562" y="482" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Phase 1 edges -->
      <bpmndi:BPMNEdge id="Flow_to_gen_ack_di" bpmnElement="Flow_to_gen_ack">
        <di:waypoint x="215" y="177" />
        <di:waypoint x="280" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_wait_ack_di" bpmnElement="Flow_to_wait_ack">
        <di:waypoint x="380" y="177" />
        <di:waypoint x="452" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ack_error_di" bpmnElement="Flow_ack_error">
        <di:waypoint x="330" y="235" />
        <di:waypoint x="330" y="500" />
        <di:waypoint x="562" y="500" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_check_ack_di" bpmnElement="Flow_to_check_ack">
        <di:waypoint x="488" y="177" />
        <di:waypoint x="555" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ack_ok_di" bpmnElement="Flow_ack_ok">
        <di:waypoint x="605" y="177" />
        <di:waypoint x="680" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ack_fail_di" bpmnElement="Flow_ack_fail">
        <di:waypoint x="580" y="202" />
        <di:waypoint x="580" y="482" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_assess_di" bpmnElement="Flow_to_assess">
        <di:waypoint x="780" y="177" />
        <di:waypoint x="850" y="177" />
      </bpmndi:BPMNEdge>

      <!-- Phase 2/3 edges -->
      <bpmndi:BPMNEdge id="Flow_to_decision_gw_di" bpmnElement="Flow_to_decision_gw">
        <di:waypoint x="900" y="217" />
        <di:waypoint x="900" y="325" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_gegrond_di" bpmnElement="Flow_gegrond">
        <di:waypoint x="925" y="350" />
        <di:waypoint x="963" y="350" />
        <di:waypoint x="963" y="280" />
        <di:waypoint x="1000" y="280" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ongegrond_di" bpmnElement="Flow_ongegrond">
        <di:waypoint x="925" y="350" />
        <di:waypoint x="963" y="350" />
        <di:waypoint x="963" y="380" />
        <di:waypoint x="1000" y="380" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_deels_gegrond_di" bpmnElement="Flow_deels_gegrond">
        <di:waypoint x="900" y="375" />
        <di:waypoint x="900" y="480" />
        <di:waypoint x="1000" y="480" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_gegrond_to_merge_di" bpmnElement="Flow_gegrond_to_merge">
        <di:waypoint x="1100" y="280" />
        <di:waypoint x="1200" y="280" />
        <di:waypoint x="1200" y="325" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ongegrond_to_merge_di" bpmnElement="Flow_ongegrond_to_merge">
        <di:waypoint x="1100" y="380" />
        <di:waypoint x="1200" y="380" />
        <di:waypoint x="1200" y="375" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_partial_to_merge_di" bpmnElement="Flow_partial_to_merge">
        <di:waypoint x="1100" y="480" />
        <di:waypoint x="1200" y="480" />
        <di:waypoint x="1200" y="375" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_wait_decision_di" bpmnElement="Flow_to_wait_decision">
        <di:waypoint x="1225" y="350" />
        <di:waypoint x="1282" y="350" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_check_decision_di" bpmnElement="Flow_to_check_decision">
        <di:waypoint x="1318" y="350" />
        <di:waypoint x="1375" y="350" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_decision_ok_di" bpmnElement="Flow_decision_ok">
        <di:waypoint x="1425" y="350" />
        <di:waypoint x="1490" y="350" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_decision_fail_di" bpmnElement="Flow_decision_fail">
        <di:waypoint x="1400" y="375" />
        <di:waypoint x="1400" y="500" />
        <di:waypoint x="598" y="500" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_end_di" bpmnElement="Flow_to_end">
        <di:waypoint x="1590" y="350" />
        <di:waypoint x="1662" y="350" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>

<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  id="Definitions_permit"
                  targetNamespace="http://bpmn.io/schema/bpmn"
                  exporter="Camunda Modeler" exporterVersion="5.23.0">

  <bpmn:message id="Message_EpistolaDocumentGenerated" name="EpistolaDocumentGenerated" />
  <bpmn:error id="Error_EpistolaDocumentError" name="EpistolaDocumentError" />

  <bpmn:process id="permit-confirmation" name="Vergunning Bevestigingsbrief" isExecutable="true">
    <bpmn:documentation>Generates a confirmation letter for a permit application, waits for completion, downloads, and presents for review.</bpmn:documentation>

    <!-- Start -->
    <bpmn:startEvent id="startEvent" name="Aanvraag ingediend">
      <bpmn:outgoing>Flow_to_generate</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- Generate confirmation letter -->
    <bpmn:serviceTask id="generate-confirmation" name="Genereer Bevestigingsbrief">
      <bpmn:incoming>Flow_to_generate</bpmn:incoming>
      <bpmn:outgoing>Flow_to_wait</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- Error boundary on generation -->
    <bpmn:boundaryEvent id="boundary-generate-error" name="Generatie fout" attachedToRef="generate-confirmation">
      <bpmn:outgoing>Flow_generate_error</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorDef_generate" errorRef="Error_EpistolaDocumentError"
                                  camunda:errorCodeVariable="errorCode" camunda:errorMessageVariable="errorMessage" />
    </bpmn:boundaryEvent>

    <!-- Wait for generation to complete -->
    <bpmn:intermediateCatchEvent id="wait-for-generation" name="Wacht op generatie">
      <bpmn:incoming>Flow_to_wait</bpmn:incoming>
      <bpmn:outgoing>Flow_to_check</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageDef_wait" messageRef="Message_EpistolaDocumentGenerated" />
    </bpmn:intermediateCatchEvent>

    <!-- Check status gateway -->
    <bpmn:exclusiveGateway id="check-status" name="Generatie geslaagd?">
      <bpmn:incoming>Flow_to_check</bpmn:incoming>
      <bpmn:outgoing>Flow_completed</bpmn:outgoing>
      <bpmn:outgoing>Flow_not_completed</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- Download confirmation letter -->
    <bpmn:serviceTask id="download-confirmation" name="Download Bevestigingsbrief">
      <bpmn:incoming>Flow_completed</bpmn:incoming>
      <bpmn:outgoing>Flow_to_review</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- Review user task -->
    <bpmn:userTask id="review-document" name="Controleer Bevestigingsbrief">
      <bpmn:incoming>Flow_to_review</bpmn:incoming>
      <bpmn:outgoing>Flow_to_end</bpmn:outgoing>
    </bpmn:userTask>

    <!-- End events -->
    <bpmn:endEvent id="end-success" name="Bevestiging verstuurd">
      <bpmn:incoming>Flow_to_end</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end-error" name="Fout">
      <bpmn:incoming>Flow_generate_error</bpmn:incoming>
      <bpmn:incoming>Flow_not_completed</bpmn:incoming>
    </bpmn:endEvent>

    <!-- Sequence flows -->
    <bpmn:sequenceFlow id="Flow_to_generate" sourceRef="startEvent" targetRef="generate-confirmation" />
    <bpmn:sequenceFlow id="Flow_to_wait" sourceRef="generate-confirmation" targetRef="wait-for-generation" />
    <bpmn:sequenceFlow id="Flow_generate_error" sourceRef="boundary-generate-error" targetRef="end-error" />
    <bpmn:sequenceFlow id="Flow_to_check" sourceRef="wait-for-generation" targetRef="check-status" />
    <bpmn:sequenceFlow id="Flow_completed" name="Ja" sourceRef="check-status" targetRef="download-confirmation">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus == 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_not_completed" name="Nee" sourceRef="check-status" targetRef="end-error">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${epistolaStatus != 'COMPLETED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_to_review" sourceRef="download-confirmation" targetRef="review-document" />
    <bpmn:sequenceFlow id="Flow_to_end" sourceRef="review-document" targetRef="end-success" />

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="permit-confirmation">
      <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
        <dc:Bounds x="179" y="159" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="155" y="202" width="84" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="generate-confirmation_di" bpmnElement="generate-confirmation">
        <dc:Bounds x="280" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="wait-for-generation_di" bpmnElement="wait-for-generation">
        <dc:Bounds x="452" y="159" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="428" y="202" width="84" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="check-status_di" bpmnElement="check-status" isMarkerVisible="true">
        <dc:Bounds x="555" y="152" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="537" y="122" width="86" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="download-confirmation_di" bpmnElement="download-confirmation">
        <dc:Bounds x="680" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="review-document_di" bpmnElement="review-document">
        <dc:Bounds x="850" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="end-success_di" bpmnElement="end-success">
        <dc:Bounds x="1022" y="159" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="998" y="202" width="84" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="end-error_di" bpmnElement="end-error">
        <dc:Bounds x="562" y="312" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="570" y="355" width="21" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="boundary-generate-error_di" bpmnElement="boundary-generate-error">
        <dc:Bounds x="312" y="199" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="296" y="242" width="68" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_to_generate_di" bpmnElement="Flow_to_generate">
        <di:waypoint x="215" y="177" />
        <di:waypoint x="280" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_wait_di" bpmnElement="Flow_to_wait">
        <di:waypoint x="380" y="177" />
        <di:waypoint x="452" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_generate_error_di" bpmnElement="Flow_generate_error">
        <di:waypoint x="330" y="235" />
        <di:waypoint x="330" y="330" />
        <di:waypoint x="562" y="330" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_check_di" bpmnElement="Flow_to_check">
        <di:waypoint x="488" y="177" />
        <di:waypoint x="555" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_completed_di" bpmnElement="Flow_completed">
        <di:waypoint x="605" y="177" />
        <di:waypoint x="680" y="177" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="637" y="159" width="12" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_not_completed_di" bpmnElement="Flow_not_completed">
        <di:waypoint x="580" y="202" />
        <di:waypoint x="580" y="312" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="586" y="253" width="19" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_review_di" bpmnElement="Flow_to_review">
        <di:waypoint x="780" y="177" />
        <di:waypoint x="850" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_to_end_di" bpmnElement="Flow_to_end">
        <di:waypoint x="950" y="177" />
        <di:waypoint x="1022" y="177" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>

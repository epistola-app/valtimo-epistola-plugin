apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "valtimo-demo.backend.fullname" . }}
  labels:
    {{- include "valtimo-demo.backend.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.backend.replicaCount }}
  selector:
    matchLabels:
      {{- include "valtimo-demo.backend.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "valtimo-demo.backend.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.backend.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: backend
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
          securityContext:
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          env:
            # Spring profile
            - name: SPRING_PROFILES_ACTIVE
              value: {{ .Values.backend.springProfilesActive | quote }}

            # Database
            {{- if or (eq .Values.database.type "cnpg") (eq .Values.database.type "cnpgExisting") }}
            - name: SPRING_DATASOURCE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "valtimo-demo.cnpg.secretName" . }}
                  key: jdbc-uri
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "valtimo-demo.cnpg.secretName" . }}
                  key: username
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "valtimo-demo.cnpg.secretName" . }}
                  key: password
            {{- else if eq .Values.database.type "external" }}
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:postgresql://{{ .Values.database.external.host }}:{{ .Values.database.external.port }}/{{ .Values.database.external.database }}"
            - name: SPRING_DATASOURCE_USERNAME
              value: {{ .Values.database.external.username | quote }}
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ required "database.external.existingSecret is required" .Values.database.external.existingSecret }}
                  key: {{ .Values.database.external.secretKey }}
            {{- end }}

            # RabbitMQ (disabled via autoconfigure exclude in application.yml, but env vars set for completeness)
            - name: SPRING_RABBITMQ_HOST
              value: {{ .Values.backend.rabbitmq.host | quote }}
            - name: SPRING_RABBITMQ_PORT
              value: {{ .Values.backend.rabbitmq.port | quote }}
            - name: SPRING_RABBITMQ_USERNAME
              value: {{ .Values.backend.rabbitmq.username | quote }}
            - name: SPRING_RABBITMQ_PASSWORD
              value: {{ .Values.backend.rabbitmq.password | quote }}

            # OAuth2 / Keycloak
            {{- $keycloakInternalUrl := include "valtimo-demo.keycloak.internalUrl" . }}
            {{- $keycloakRealm := .Values.backend.keycloak.realm }}
            - name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWKSETURI
              value: "{{ $keycloakInternalUrl }}/realms/{{ $keycloakRealm }}/protocol/openid-connect/certs"
            - name: SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAKJWT_ISSUERURI
              value: "{{ $keycloakInternalUrl }}/realms/{{ $keycloakRealm }}"
            - name: SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAKAPI_ISSUERURI
              value: "{{ $keycloakInternalUrl }}/realms/{{ $keycloakRealm }}"
            - name: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAKJWT_CLIENTID
              value: {{ .Values.backend.keycloak.clientId | quote }}
            - name: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAKAPI_CLIENTID
              value: {{ .Values.backend.keycloak.backendClientId | quote }}
            - name: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAKAPI_CLIENTSECRET
              value: {{ .Values.backend.keycloak.backendClientSecret | quote }}

            # Valtimo
            - name: VALTIMO_APP_HOSTNAME
              value: {{ .Values.backend.valtimo.appHostname | quote }}
            - name: VALTIMO_PLUGIN_ENCRYPTIONSECRET
              value: {{ .Values.backend.valtimo.pluginEncryptionSecret | quote }}

            # Epistola
            - name: EPISTOLA_BASE_URL
              value: {{ include "valtimo-demo.epistola.serviceUrl" . | quote }}

            # Operaton BPMN engine
            - name: OPERATON_BPM_ADMINUSER_PASSWORD
              value: {{ .Values.backend.operaton.adminPassword | quote }}

            {{- with .Values.backend.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}

          {{- with .Values.backend.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.backend.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.backend.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      volumes:
        - name: tmp
          emptyDir: {}
      {{- with .Values.backend.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.backend.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
